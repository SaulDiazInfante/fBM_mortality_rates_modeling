define(["require","exports","tslib","modules/clean/ajax","external/lodash","modules/core/i18n","modules/clean/web_timing_logger","modules/core/cookies","modules/core/notify","modules/core/uri","modules/clean/api_v2/transport/jquery","modules/clean/react/modal","modules/clean/react/extensions/auth_modal","modules/clean/filepath","modules/clean/react/extensions/cloud_docs_compat","modules/clean/cloud_docs/event_logging","modules/clean/cloud_docs/open_with_utils"],function(e,t,r,i,n,o,a,s,c,u,d,l,_,h,f,m,p){"use strict";function w(e,t,i){return r.__awaiter(this,void 0,void 0,function(){var n,o,a,c,l,_;return r.__generator(this,function(r){switch(r.label){case 0:if(n=new d.JQueryAsyncTransport,o=new u.URI({scheme:"https",authority:"www.dropbox.com",path:"/2/app_actions/"+t}),a={},a["X-Dropbox-Path-Root"]=e.root_ns_id.toString(),a["X-Dropbox-Uid"]=e.id.toString(),c=s.Cookies.read("__Host-js_csrf"),!c)throw new Error("No CSRF cookie");return a["X-CSRF-Token"]=c,[4,n.executeRpc(o,a,JSON.stringify(i),"application/json")];case 1:return l=r.sent(),_={request_id:l.headers["x-dropbox-request-id"],redirect_url:l.result.redirect_url},"link_state"in l.result&&(_.link_state=l.result.link_state),[2,_]}})})}function g(e,t,i,n,o){return r.__awaiter(this,void 0,void 0,function(){var a;return r.__generator(this,function(r){switch(r.label){case 0:return a=function(){return w(e,"redirect",{action_id:t,file_id:n})},[4,k(e,t,i,n,a,o)];case 1:return r.sent(),[2]}})})}function v(e,t,i,n,o,a){return r.__awaiter(this,void 0,void 0,function(){var n,s,c,u,d,w,v,b;return r.__generator(this,function(r){if("redirect"===i.handler[".tag"])n=i.handler.window_params,s=void 0,"popup"===n[".tag"]&&(c=n.width,u=n.height,s="width="+c+",height="+u),d="sfa_unlinked"===i.link_state[".tag"]&&!i.id.startsWith("fp_action_id:"),d?(w=h.filename(t.ns_path),_.showAuthModal(i.id,i.description,i.icon.url,t.file_id,w,function(){l.Modal.close(),x(e,i.id,i.description,t.file_id,s,a)})):g(e,i.id,i.description,t.file_id,s);else{if("cloud_editor"!==i.handler[".tag"])throw new Error('Unexpected handler "'+i.handler[".tag"]+'"');v=o?m.getActionSourceFromSurface(o.surface):void 0,b=f.cloudEditorNameToParams(i.handler.editor_name),p.openWithCloudEditor(t,e,b,!1,v)}return[2]})})}function x(e,t,i,n,o,a){return r.__awaiter(this,void 0,void 0,function(){var s;return r.__generator(this,function(r){switch(r.label){case 0:return[4,b(e,t,i,n,o)];case 1:return s=r.sent(),a&&s&&s.link_state&&a(t,s.link_state),[2]}})})}function b(e,t,i,n,o){return r.__awaiter(this,void 0,void 0,function(){var a;return r.__generator(this,function(r){switch(r.label){case 0:return a=function(){return w(e,"authorize",{action_id:t,file_id:n})},[4,k(e,t,i,n,a,o)];case 1:return[2,r.sent()]}})})}function k(e,t,s,u,d,l){return r.__awaiter(this,void 0,Promise,function(){function _(){return r.__awaiter(this,void 0,void 0,function(){var e;return r.__generator(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,d()];case 1:return[2,t.sent()];case 2:return e=t.sent(),w=!0,[2,void 0];case 3:return[2]}})})}var h,f,m,p,w,g,v,x,b,k,S;return r.__generator(this,function(r){switch(r.label){case 0:return a.delete_timer("extensions_redirect_handoff"),h=a.get_timer("extensions_redirect_handoff"),f=t&&t.startsWith("fp_action_id:")?"extensions_shortcut_handoff":"extensions_redirect_handoff",h.initialize({requireTTI:!0,requireTTV:!1,url:f}),m="action_redirect_"+Math.random().toString(16).substring(2),p=window.open("",m,l),p&&(p.document.open("text/html","replace"),p.document.write("<html><head><title>"+n.escape(s)+"</title></head></html>"),p.document.close()),w=!1,g=new Promise(function(r){i.SilentBackgroundRequest({url:"/aa/loading",subject_user:e.id,data:{file_id:u,action_id:t},success:function(e){!w&&p?(p.document.open("text/html","replace"),p.document.write(e),p.document.close(),p.document.title=s,r()):r()},error:function(){r()}})}),[4,Promise.all([g,_()])];case 1:return v=r.sent(),x=v[1],b=x&&x.redirect_url||"/aa/error",p?p.location.replace(b):(k=window.open(b,"_blank",l),k||(S=s,c.Notify.error(o._("Failed to open %(app_name)s").format({app_name:S})))),x&&x.request_id&&(h.markTimeToInteractive(),h.end(x.request_id)),[2,x]}})})}Object.defineProperty(t,"__esModule",{value:!0}),i=r.__importStar(i),n=r.__importStar(n),h=r.__importStar(h);t.fetchUrl=w,t.redirectToAction=g,t.redirectToActionOrShowAuth=v,t.authAction=b,t.showLoadingPageAndDoRedirect=k});
//# sourceMappingURL=redirect.min.js-vflwAwLWG.map